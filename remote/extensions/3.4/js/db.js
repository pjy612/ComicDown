DB.CONFIG={db:{name:"MSQ",desc:"Niubility Comic Artifact",size:2},latest:{version:"3.0",create:function(a){a.executeSql("CREATE TABLE IF NOT EXISTS fav (favId INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT UNIQUE, comicId INTEGER,comicCode TEXT, site TEXT,name TEXT, cover TEXT, lastReadChapterId INTEGER,lastReadChapterCode TEXT, lastReadChapterName TEXT,lastReadChapterUrl TEXT ,lastReadChapterPageNo INTEGER, maxReadChapterId INTEGER, maxReadChapterCode TEXT, maxReadChapterNo INTEGER, lastReadTime INTEGER, createTime INTEGER, lastChapterId INTEGER,lastChapterCode TEXT, lastChapterName TEXT,lastChapterNo INTEGER, lastUpdateTime INTEGER, lastChapterCount INTEGER, isUpdate INTEGER)",[],txSuccess,txError);a.executeSql("CREATE TABLE IF NOT EXISTS read_log (logId INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT UNIQUE, comicId INTEGER, site TEXT, createTime INTEGER, lastReadTime INTEGER, readNumber INTEGER,name TEXT, cover TEXT, lastReadChapterId INTEGER, lastReadChapterName TEXT,lastReadChapterUrl TEXT ,lastReadChapterPageNo INTEGER)",[],txSuccess,txError);a.executeSql("CREATE TABLE IF NOT EXISTS download (downloadId INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT unique, comicId INTEGER, site TEXT,name TEXT, cover TEXT, chapterId INTEGER, chapterName TEXT, chapterCode TEXT, pageMax INTEGER, status TEXT, downloadStatus TEXT, createTime INTEGER, chromeDownloadId INTEGER) ",[],txSuccess,txError)}},clear:function(a){a.executeSql("DROP TABLE fav",[],txSuccess,txError);a.executeSql("DROP TABLE read_log",[],txSuccess,txError);a.executeSql("DROP TABLE download",[],txSuccess,txError)},update:{"1.0":function(a){a.executeSql("CREATE TABLE IF NOT EXISTS fav (favId INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT UNIQUE, comicId INTEGER,comicCode TEXT, site TEXT,name TEXT, cover TEXT, lastReadChapterId INTEGER,lastReadChapterCode TEXT, lastReadChapterName TEXT,lastReadChapterUrl TEXT ,lastReadChapterPageNo INTEGER, maxReadChapterId INTEGER, maxReadChapterCode TEXT, maxReadChapterNo INTEGER, lastReadTime INTEGER, createTime INTEGER, lastChapterId INTEGER,lastChapterCode TEXT, lastChapterName TEXT,lastChapterNo INTEGER, lastUpdateTime INTEGER, lastChapterCount INTEGER, isUpdate INTEGER)",[],txSuccess,txError);a.executeSql("CREATE TABLE IF NOT EXISTS read_log (logId INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT UNIQUE, comicId INTEGER, site TEXT, createTime INTEGER, lastReadTime INTEGER, readNumber INTEGER,name TEXT, cover TEXT, lastReadChapterId INTEGER, lastReadChapterName TEXT,lastReadChapterUrl TEXT ,lastReadChapterPageNo INTEGER)",[],txSuccess,txError)},"3.0":function(a){a.executeSql("CREATE TABLE IF NOT EXISTS download (downloadId INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT unique, comicId INTEGER, site TEXT,name TEXT, cover TEXT, chapterId INTEGER, chapterName TEXT, chapterCode TEXT, pageMax INTEGER, status TEXT, downloadStatus TEXT, createTime INTEGER, chromeDownloadId INTEGER) ",[],txSuccess,txError)}}};DB.deleteDB=function(){DB.db.changeVersion(DB.db.version,"0.0",function(a){log("DB删除开始 version:"+DB.db.version);DB.CONFIG.clear(a)})};DB.createDB=function(a){var b=DB.CONFIG.latest.version;a.changeVersion(a.version,b,function(c){log("DB创建开始 version:"+b);DB.CONFIG.latest["create"](c)},function(c){console.error("DB创建失败 version:"+b);console.error(c)},function(){log("DB创建成功 version:"+a.version)})};DB.checkUpdateDB=function(c,d){if(c.version==d){log("DB 是最新版本 version:"+c.version);return false}else{if(c.version==""||c.version=="0.0"){DB.createDB(c);return false}}var a="1.0";for(var b in DB.CONFIG.update){if(a==""){a=b;break}if(b==c.version){a=""}}c.changeVersion(c.version,a,function(e){log("DB升级开始 version:"+c.version+" -> "+a);DB.CONFIG.update[a](e)},function(e){console.error("DB升级失败"+c.version+" -> "+a);console.error(e)},function(){log("DB升级成功 version:"+c.version);DB.checkUpdateDB(c,d)});return true};DB_FUN={};DB_FUN.addReadLog=function(f,b){var d=f.site;var c=f.chapter;var e=getNowTimeStamp();var a={};DB.db.transaction(function(g){g.executeSql("SELECT * FROM read_log WHERE comicId = ? AND site = ?",[c.comicId,d],function(i,h){if(h.rows.length>0){a=h.rows.item(0);var j=a.readNumber+1;i.executeSql("UPDATE read_log SET lastReadTime=?,readNumber=?,lastReadChapterId=?,lastReadChapterName=?,lastReadChapterUrl=?,lastReadChapterPageNo=? WHERE logId=?",[e,j,c.chapterId,c.chapterName,c.chapterUrl,c.pageNo,a.logId],function(l,k){b({readNumber:j})},txError)}else{i.executeSql("INSERT INTO read_log (comicId,site,createTime,lastReadTime,readNumber,name,cover,lastReadChapterId,lastReadChapterName,lastReadChapterUrl,lastReadChapterPageNo) VALUES (?,?,?,?,?,?,?,?,?,?,?)",[c.comicId,d,e,e,1,c.comicName,c.cover,c.chapterId,c.chapterName,c.chapterUrl,c.pageNo],function(l,k){b({logId:k.insertId})},txError)}},txError)})};DB_FUN.hasFav=function(b,a){DB.db.transaction(function(c){c.executeSql("SELECT * FROM fav WHERE comicId = ? AND site = ?",[b.chapter.comicId,b.site],function(e,d){if(d.rows.length>0){a(true)}else{a(false)}},txError)})};DB_FUN.addFav=function(g,a){var c=g.site;var b=g.chapter;var e=getNowTimeStamp();var f=b.chapterList[b.chapterList.length-1];var d={};DB.db.transaction(function(h){h.executeSql("SELECT * FROM fav WHERE comicId = ? AND site = ?",[b.comicId,c],function(j,i){if(i.rows.length==0){j.executeSql("INSERT INTO fav (comicId,comicCode,site,name,cover,lastReadChapterId,lastReadChapterCode,lastReadChapterName,lastReadChapterUrl,lastReadChapterPageNo,maxReadChapterId,maxReadChapterCode,maxReadChapterNo,lastReadTime,createTime,lastChapterId,lastChapterCode,lastChapterName,lastChapterNo,lastUpdateTime,lastChapterCount,isUpdate) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)",[b.comicId,b.comicCode,c,b.comicName,b.cover,b.chapterId,b.chapterCode,b.chapterName,b.chapterUrl,b.pageNo,b.chapterId,b.chapterCode,b.chapterNo,e,e,f.id,f.code,f.name,f.no,e,b.chapterList.length,0],function(l,k){console.log("!!!!!!  add favId"+k.favId+" ,"+b.comicName);a({favId:k.insertId});sendMessageToReader("addFav",{comicId:b.comicId,site:c})},txError)}},txError)})};DB_FUN.updateFav=function(g,a){var c=g.site;var b=g.chapter;var e=getNowTimeStamp();var f=b.chapterList[b.chapterList.length-1];var d={};DB.db.transaction(function(h){h.executeSql("SELECT * FROM fav WHERE comicId = ? AND site = ?",[b.comicId,c],function(k,r){var q,i,m,j,o,n,p,l;if(r.rows.length>0){d=r.rows.item(0);if(d.maxReadChapterNo<b.chapterNo){q=b.chapterNo;i=b.chapterId;m=b.chapterCode}else{q=d.maxReadChapterNo;i=d.maxReadChapterId;m=d.maxReadChapterCode}if(f.id!=d.lastChapterId){j=f.id;o=f.code;n=f.name;p=f.no;l=e}else{j=d.lastChapterId;o=d.lastChapterCode;n=d.lastChapterName;p=d.lastChapterNo;l=d.lastUpdateTime}k.executeSql("UPDATE fav SET lastReadChapterId=?,lastReadChapterCode=?, lastReadChapterName=?, lastReadChapterUrl=?, lastReadChapterPageNo=?, maxReadChapterId=?,maxReadChapterCode=?, maxReadChapterNo=?, lastReadTime=?,lastChapterId=?,lastChapterCode=?, lastChapterName=?,lastChapterNo=?, lastUpdateTime=?,lastChapterCount=? WHERE favId=?",[b.chapterId,b.chapterCode,b.chapterName,b.chapterUrl,b.pageNo,i,m,q,e,j,o,n,p,l,b.chapterList.length,d.favId],function(t,s){console.log("!!!!!!  update favId"+d.favId+" ,"+d.name);a(d)},txError)}},txError)})};DB_FUN.checkFav=function(e,a){var b=e.site;var d=e.fav;var c=getNowTimeStamp();DB.db.transaction(function(f){f.executeSql("UPDATE fav SET lastChapterId=?, lastChapterCode=?, lastChapterName=?, lastChapterNo=?, lastUpdateTime=?,lastChapterCount=?,isUpdate=? WHERE favId=?",[e.lastChapterId,e.lastChapterCode,e.lastChapterName,e.lastChapterNo,c,e.lastChapterCount,1,d.favId],function(h,g){console.log("!!!!!!  check update favId"+d.favId+" ,"+d.name)},txError)})};DB_FUN.setIsUpdateFav=function(a){DB.db.transaction(function(b){b.executeSql("UPDATE fav SET isUpdate=0 WHERE comicId = ? AND site = ?",[a.comicId,a.site],function(d,c){},txError)})};DB_FUN.countIsUpdateFav=function(b,a){DB.db.transaction(function(c){c.executeSql("SELECT COUNT(*) AS count FROM fav WHERE isUpdate=1",[],function(e,d){a(d.rows.item(0))},txError)})};DB_FUN.deleteFav=function(b,a){DB.db.transaction(function(c){c.executeSql("DELETE FROM fav WHERE comicId = ? AND site = ?",[b.comicId,b.site],function(e,d){a(true);sendMessageToReader("deleteFav",{comicId:b.comicId,site:b.site})},txError)})};DB_FUN.getFavList=function(c,a){var b;DB.db.transaction(function(d){d.executeSql("SELECT * FROM fav ORDER BY lastReadTime DESC",[],function(f,h){var e=h.rows.length,g;b=[];for(g=0;g<e;g++){b[g]=h.rows.item(g)}a(b)},txError)})};DB_FUN.getFav=function(b,a){DB.db.transaction(function(c){c.executeSql("SELECT * FROM fav WHERE comicId = ? AND site = ?",[b.comicId,b.site],function(d,e){var f=null;if(e.rows.length>0){f=e.rows.item(0)}a(f)},txError)})};DB_FUN.getDownloadList=function(b,a){DB.db.transaction(function(c){c.executeSql("SELECT * FROM download order by createTime desc",[],function(e,g){var d=g.rows.length,f;list=[];for(f=0;f<d;f++){list[f]=g.rows.item(f)}a(list)},txError)})};DB_FUN.addDownload=function(e,a){var c=e.site;var b=e.download;var d=getNowTimeStamp();DB.db.transaction(function(f){f.executeSql("INSERT INTO download (comicId, site, name, cover, chapterId, chapterName, chapterCode, pageMax, status, downloadStatus, createTime, chromeDownloadId) VALUES (?,?,?,?,?,?,?,?,?,?,?,?)",[b.comicId,c,b.name,b.cover,b.chapterId,b.chapterName,b.chapterCode,b.pageMax,b.status,b.downloadStatus,d,0],function(h,g){a({downloadId:g.insertId})},txError)})};DB_FUN.deleteDownload=function(b,a){DB.db.transaction(function(c){c.executeSql("DELETE FROM download WHERE downloadId=?",[b.downloadId],function(e,d){a({message:"删除成功"})},txError)})};DB_FUN.updateDownloadComplete=function(b,a){DB.db.transaction(function(c){c.executeSql("UPDATE download SET downloadStatus='downloaded', status='stop', chromeDownloadId=? WHERE downloadId = ?",[b.chromeDownloadId,b.downloadId],function(e,d){},txError)})};txSuccess=function(b,a){};txError=function(a,b){console.error(b)};true;